---
title: "TypeScriptã§å®‰å…¨ã«å°æ•°ç‚¹ã‚’æ‰±ã†ãƒã‚¤ãƒ³ãƒˆãƒ»ã‚¹ã‚³ã‚¢ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ®"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["typescript"]
published: true
publication_name: noplan_inc
---


# ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ï¼ no plan inc. ã«ã¦ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚„ã£ã¦ã¾ã™ [@somaseki](https://twitter.com/somaseki)ã§ã™ã€‚
ã“ã‚Œã¯[no plan inc.ã® Advent Calendar 2024](https://qiita.com/advent-calendar/2024/noplan_inc)ã®14æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

## ã“ã®è¨˜äº‹ã®å†…å®¹

typescriptã«ã‚ˆã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ãŠã„ã¦ã€å°æ•°ç‚¹ã‚’å«ã‚€ãƒã‚¤ãƒ³ãƒˆã‚„ã‚¹ã‚³ã‚¢ã®ç®¡ç†ã‚’ã™ã‚‹å ´é¢ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ãã®éš›ã«ä½¿ãˆãã†ãªã‚¯ãƒ©ã‚¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
æ—¢å­˜ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚å­˜åœ¨ã—ã¾ã™ãŒã€ä»Šå›ã¯ä½¿ã‚ãšã«ã‚„ã‚‹ã“ã¨å‰æã§ã‚„ã‚Šã¾ã™ã€‚

## ãƒã‚¤ãƒ³ãƒˆãƒ»ã‚¹ã‚³ã‚¢ã‚’æ‰±ã†éš›ã®èª²é¡Œ

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ãŠã„ã¦ã€å°æ•°ç‚¹ã‚’å«ã‚€ãƒã‚¤ãƒ³ãƒˆã‚„ã‚¹ã‚³ã‚¢ã®ç®¡ç†ã¯æ„å¤–ã¨é›£ã—ã„å•é¡Œã§ã™ã€‚ç‰¹ã«ä»¥ä¸‹ã®ã‚ˆã†ãªèª²é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

1. æµ®å‹•å°æ•°ç‚¹æ•°ã®ç²¾åº¦å•é¡Œ
   ```javascript
   0.1 + 0.2 // => 0.30000000000000004
   ```

2. ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–“ã§ã®ä¸€è²«æ€§
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–“ã§å€¤ãŒå¾®å¦™ã«ç•°ãªã‚‹å¯èƒ½æ€§
   - ä¸¸ã‚å‡¦ç†ã«ã‚ˆã‚‹å·®ç•°

3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã®æ‰±ã„
   - DOUBLEå‹ã‚„FLOATå‹ã§ã¯ç²¾åº¦ã®ä¿è¨¼ãŒé›£ã—ã„
   - æ¯”è¼ƒã‚„ã‚½ãƒ¼ãƒˆã®éš›ã«äºˆæœŸã›ã¬çµæœãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§

ã“ã‚Œã‚‰ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€å°æ•°ç‚¹ä»¥ä¸‹3æ¡ã¾ã§ã‚’å®‰å…¨ã«æ‰±ãˆã‚‹FixedPointã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚


# å®Ÿè£…

```typescript
// å€¤ã®çŠ¶æ…‹ã‚’è¡¨ã™ãƒ¦ãƒ‹ã‚ªãƒ³å‹
type ValueState = 'stored' | 'display';

// çŠ¶æ…‹ã«å¿œã˜ãŸå‹ã‚’ç”Ÿæˆã™ã‚‹ã‚¸ã‚§ãƒãƒªãƒƒã‚¯å‹
type TypedNumber<S extends ValueState> = {
  readonly value: number;
  readonly __state: S;
};

export class FixedPoint<S extends ValueState> {
  private static readonly PRECISION = 3;
  private static readonly SCALE_FACTOR = Math.pow(10, FixedPoint.PRECISION);
  private static readonly MAX_VALUE = 999999999;
  private static readonly MIN_VALUE = -999999999;

  private constructor(
    private readonly typedValue: TypedNumber<S>
  ) {}

  static validate(value: number): void {
    if (!Number.isFinite(value)) {
      throw new Error('Invalid number value');
    }
    if (value > this.MAX_VALUE || value < this.MIN_VALUE) {
      throw new Error('Value out of range');
    }
  }

  static fromNumber(value: number): FixedPoint<'display'> {
    this.validate(value);
    const roundedValue = Math.floor(value * this.SCALE_FACTOR) / this.SCALE_FACTOR;
    return new FixedPoint<'display'>({
      value: roundedValue,
      __state: 'display'
    });
  }

  static fromStoredValue(value: number): FixedPoint<'stored'> {
    this.validate(value);
    return new FixedPoint<'stored'>({
      value,
      __state: 'stored'
    });
  }

  static zero(): FixedPoint<'display'> {
    return new FixedPoint<'display'>({
      value: 0,
      __state: 'display'
    });
  }

  toDisplayValue(): FixedPoint<'display'> {
    if (this.typedValue.__state === 'display') {
      return this as FixedPoint<'display'>;
    }
    return new FixedPoint<'display'>({
      value: this.typedValue.value / FixedPoint.SCALE_FACTOR,
      __state: 'display'
    });
  }

  toStoredValue(): FixedPoint<'stored'> {
    if (this.typedValue.__state === 'stored') {
      return this as FixedPoint<'stored'>;
    }
    return new FixedPoint<'stored'>({
      value: Math.floor(this.typedValue.value * FixedPoint.SCALE_FACTOR),
      __state: 'stored'
    });
  }

  toNumber(): number {
    return this.typedValue.__state === 'stored' 
      ? this.typedValue.value / FixedPoint.SCALE_FACTOR 
      : this.typedValue.value;
  }

  toString(): string {
    return this.toNumber().toFixed(FixedPoint.PRECISION);
  }

  isZero(): boolean {
    return this.toNumber() === 0;
  }

  add(other: FixedPoint<ValueState>): FixedPoint<'display'> {
    return FixedPoint.fromNumber(
      this.toNumber() + other.toNumber()
    );
  }

  sub(other: FixedPoint<ValueState>): FixedPoint<'display'> {
    return FixedPoint.fromNumber(
      this.toNumber() - other.toNumber()
    );
  }

  mul(other: FixedPoint<ValueState>): FixedPoint<'display'> {
    return FixedPoint.fromNumber(
      this.toNumber() * other.toNumber()
    );
  }

  div(other: FixedPoint<ValueState>): FixedPoint<'display'> {
    const otherValue = other.toNumber();
    if (otherValue === 0) {
      throw new Error('Division by zero');
    }
    return FixedPoint.fromNumber(
      this.toNumber() / otherValue
    );
  }

  eq(other: number | FixedPoint<ValueState>): boolean {
    const otherValue = other instanceof FixedPoint ? other.toNumber() : other;
    return this.toNumber() === otherValue;
  }

  gt(other: number | FixedPoint<ValueState>): boolean {
    const otherValue = other instanceof FixedPoint ? other.toNumber() : other;
    return this.toNumber() > otherValue;
  }

  lt(other: number | FixedPoint<ValueState>): boolean {
    const otherValue = other instanceof FixedPoint ? other.toNumber() : other;
    return this.toNumber() < otherValue;
  }

  abs(): FixedPoint<'display'> {
    return FixedPoint.fromNumber(Math.abs(this.toNumber()));
  }

  toJSON(): { value: number; state: ValueState } {
    return {
      value: this.typedValue.value,
      state: this.typedValue.__state
    };
  }

  static fromJSON(json: { value: number; state: ValueState }): FixedPoint<ValueState> {
    this.validate(json.value);
    return new FixedPoint({
      value: json.value,
      __state: json.state
    });
  }
}
```

## å®Ÿè£…ã®è§£èª¬

### å‹å®‰å…¨æ€§ã®ç¢ºä¿

å€¤ã®çŠ¶æ…‹ï¼ˆä¿å­˜ç”¨/è¡¨ç¤ºç”¨ï¼‰ã‚’å‹ãƒ¬ãƒ™ãƒ«ã§ç®¡ç†ã™ã‚‹ã“ã¨ã§ã€èª¤ã£ãŸä½¿ç”¨ã‚’é˜²ãã¾ã™ã€‚

```typescript
// OKãªä¾‹
const displayValue = FixedPoint.fromNumber(1.234);    // FixedPoint<'display'>
const storedValue = displayValue.toStoredValue();     // FixedPoint<'stored'>

// ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ä¾‹
const invalid: FixedPoint<'stored'> = displayValue;   // å‹ã‚¨ãƒ©ãƒ¼
```


### å€¤ã®åˆ¶é™ã¨æ¤œè¨¼

ç„¡åŠ¹ãªå€¤ã‚„ç¯„å›²å¤–ã®å€¤ã‚’ç¢ºå®Ÿã«æ¤œå‡ºã—ã¾ã™ã€‚

```typescript
static validate(value: number): void {
  if (!Number.isFinite(value)) {
    throw new Error('Invalid number value');
  }
  if (value > this.MAX_VALUE || value < this.MIN_VALUE) {
    throw new Error('Value out of range');
  }
}
```


### ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªè¨­è¨ˆ

```typescript
private constructor(
  private value: StoredValue | DisplayValue,
  private isStored: boolean
) {}
```

constructorã‚’privateã«ã—ã€ã™ã¹ã¦ã®æ“ä½œãŒæ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€å€¤ã®ä¸å¤‰æ€§ã‚’ä¿è¨¼ã—ã¦ã„ã¾ã™ã€‚

### æ•°å€¤å¤‰æ›

ã™ã¹ã¦ã®æ¼”ç®—ã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã—ã€ç²¾åº¦ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

```typescript
const value1 = FixedPoint.fromNumber(1.234);
const value2 = FixedPoint.fromNumber(2.345);

const sum = value1.add(value2);        // 3.579
const product = value1.mul(value2);    // 2.894
```

### ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®ã‚µãƒãƒ¼ãƒˆ

```typescript
toJSON(): { value: number; state: ValueState } {
    return {
      value: this.typedValue.value,
      state: this.typedValue.__state
    };
  }

static fromJSON(json: { value: number; state: ValueState }): FixedPoint<ValueState> {
    this.validate(json.value);
    return new FixedPoint({
        value: json.value,
        __state: json.state
    });
}
```

## ã¾ã¨ã‚

ã“ã®FixedPointã‚¯ãƒ©ã‚¹ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚

1. å°æ•°ç‚¹ä»¥ä¸‹Næ¡ã¾ã§ã®ç²¾åº¦ã‚’ä¿è¨¼
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã®é€£æºã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆ
3. å‹å®‰å…¨æ€§ã®ç¢ºä¿
4. ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªå®Ÿè£…
5. è±Šå¯Œãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¡ã‚½ãƒƒãƒ‰

æ³¨æ„ç‚¹ã¨ã—ã¦

1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿ï¼ˆå¤‰æ›å‡¦ç†ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ï¼‰
2. æ‰±ãˆã‚‹å€¤ã®ç¯„å›²ã«åˆ¶é™ãŒã‚ã‚‹
3. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒè‹¥å¹²å¢—ãˆã‚‹

å®Ÿéš›ã®ä½¿ç”¨æ™‚ã¯ã€ã“ã‚Œã‚‰ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’è€ƒæ…®ã—ãŸä¸Šã§ã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚

# ãŠã‚ã‚Šã«

å°æ•°ç‚¹ã‚’æ‰±ã†å‡¦ç†ã¯ä¸€è¦‹å˜ç´”ã«è¦‹ãˆã¾ã™ãŒã€æ„å¤–ã¨è¤‡é›‘ãªå•é¡Œã‚’å«ã‚“ã§ã„ã¾ã™ã€‚
ã¿ãªã•ã‚“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚ã€ä¼¼ãŸã‚ˆã†ãªèª²é¡Œã«ç›´é¢ã—ãŸéš›ã¯ã€ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å‚è€ƒã«ã—ã¦ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚


# no planæ ªå¼ä¼šç¤¾ã«ã¤ã„ã¦

- no planæ ªå¼ä¼šç¤¾ã¯ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³æŠ€è¡“ã€Webã‚µã‚¤ãƒˆé–‹ç™ºã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªé–‹ç™ºã€ãƒãƒ¼ãƒ è‚²æˆã€ãªã©Webã‚µãƒ¼ãƒ“ã‚¹å…¨èˆ¬ã®é–‹ç™ºã‹ã‚‰é‹ç”¨ã‚„æ•™è‚²ã€æ”¯æ´ãªã©ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ã‚ˆãã‚ã‹ã‚‰ãªã„ã€ãµã‚ãµã‚ã—ãŸãƒãƒ¼ãƒ—ãƒ©ãƒ³çŠ¶æ…‹ã§ã‚‚å¤§ä¸ˆå¤«ï¼ã”ä¸€ç·’ã«ãƒ—ãƒ©ãƒ³ã‚’ç«‹ã¦ã¦ã„ãã¾ã—ã‚‡ã†ï¼
- [no planæ ªå¼ä¼šç¤¾ã«ã¤ã„ã¦](https://noplan-inc.com)
- [no planæ ªå¼ä¼šç¤¾ | web3å®Ÿç¸¾](https://noplan-inc.com/web3)
- [no planæ ªå¼ä¼šç¤¾ | ãƒ–ãƒ­ã‚°ä¸€è¦§](https://noplan-inc.com/blog)

